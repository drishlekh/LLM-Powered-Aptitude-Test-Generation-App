<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Session</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .dark body { background-color: #111827; color: #fff; }
        .dark .card { background-color: rgba(31, 41, 55, 0.9); }
        .question-palette-item { transition: all 0.2s ease-in-out; }
        .option { transition: all 0.2s ease-in-out; cursor: pointer; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; }
        .option.correct { border-color: #10B981; background-color: rgba(16, 185, 129, 0.3); }
        .option.incorrect { border-color: #EF4444; background-color: rgba(239, 68, 68, 0.3); }
    </style>
</head>
<body class="min-h-screen bg-gray-900 flex items-center justify-center p-4">

    <div class="w-full max-w-4xl">
        <div class="card rounded-xl p-8 shadow-2xl">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div id="question-counter" class="text-sm font-medium text-gray-400"></div>
                {% if timed_test %}
                <div id="timer" class="timer px-3 py-1 bg-red-800 rounded-md font-medium"></div>
                {% endif %}
            </div>
            
            <!-- Question Palette -->
            <div class="grid grid-cols-10 gap-2 mb-6" id="question-palette">
                <!-- Palette will be generated by JavaScript -->
            </div>
            
            <!-- Question Body -->
            <div class="mb-6 min-h-[120px]">
                <div class="mb-3">
                    <span id="question-topic" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-300 bg-blue-800"></span>
                </div>
                <h2 id="question-text" class="text-xl font-semibold"></h2>
            </div>
            
            <!-- Options -->
            <div id="options-container" class="space-y-3 mb-6"></div>
            
            <!-- Feedback and Solution -->
            <div id="feedback-container" class="hidden mb-4 p-4 rounded-md">
                <div id="feedback-result" class="font-bold text-lg mb-2"></div>
                <div id="feedback-solution"></div>
            </div>
            
            <!-- Navigation -->
            <div class="flex justify-between items-center mt-6">
                 <button id="finish-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md">
                    Finish Test
                </button>
                <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md hidden">
                    Next Question
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA and STATE ---
        const questions = {{ questions | tojson | safe }};
        const subjectMap = {{ subject_map | tojson | safe }};
        let currentQuestionIndex = 0;
        const userAnswers = {}; // To track answered state for UI

        // --- DOM ELEMENTS ---
        const questionCounter = document.getElementById('question-counter');
        const questionPalette = document.getElementById('question-palette');
        const questionTopic = document.getElementById('question-topic');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackSolution = document.getElementById('feedback-solution');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        
        // --- TIMER ---
        const timerElement = document.getElementById('timer');
        let timeLeft = {{ time_left if time_left is not none else 'null' }};
        if (timerElement && timeLeft !== null) {
            const timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = Math.floor(timeLeft % 60);
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishTest();
                }
            }, 1000);
        }

        // --- FUNCTIONS ---
        function renderQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];

            // Update text content
            questionCounter.textContent = `Question ${index + 1} of ${questions.length}`;
            const subjectAbbr = subjectMap[question.subject] || 'G';
            questionTopic.textContent = `${subjectAbbr} -> ${question.chapter || 'General'}`;
            questionText.textContent = question.question;

            // Render options
            optionsContainer.innerHTML = '';
            for (const [letter, optionText] of Object.entries(question.options)) {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option p-4 border border-gray-600 rounded-md hover:bg-gray-700';
                optionDiv.dataset.option = letter;
                optionDiv.innerHTML = `<span class="font-bold mr-3">${letter})</span><span>${optionText}</span>`;
                optionDiv.addEventListener('click', () => handleOptionClick(letter));
                optionsContainer.appendChild(optionDiv);
            }

            // Hide feedback and next button
            feedbackContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            
            updatePalette();
        }

        function handleOptionClick(selectedOption) {
            // Prevent re-answering
            if (userAnswers[currentQuestionIndex] !== undefined) return;

            userAnswers[currentQuestionIndex] = selectedOption;

            fetch("{{ url_for('check_answer') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    question_index: currentQuestionIndex,
                    selected_option: selectedOption
                }),
            })
            .then(res => res.json())
            .then(data => {
                feedbackResult.textContent = data.is_correct ? 'Correct!' : 'Incorrect. The correct answer is ' + data.correct_answer;
                feedbackSolution.innerHTML = `<b>Solution:</b><br>${data.solution.replace(/\n/g, '<br>')}`;
                feedbackContainer.className = `p-4 rounded-md ${data.is_correct ? 'bg-green-800' : 'bg-red-800'}`;
                
                // Show feedback and next button
                feedbackContainer.classList.remove('hidden');
                if (currentQuestionIndex < questions.length - 1) {
                    nextBtn.classList.remove('hidden');
                }
                
                // Style options
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.add('disabled');
                    if(opt.dataset.option === data.correct_answer) opt.classList.add('correct');
                    else if(opt.dataset.option === selectedOption) opt.classList.add('incorrect');
                });
                
                updatePalette();
            });
        }
        
        function updatePalette() {
            questionPalette.innerHTML = '';
            for (let i = 0; i < questions.length; i++) {
                const item = document.createElement('div');
                item.dataset.index = i;
                item.textContent = i + 1;
                
                let baseStyle = 'question-palette-item rounded-full text-sm font-medium flex items-center justify-center cursor-pointer';
                let colorStyle = 'bg-gray-700 text-gray-300'; // Default: Unvisited

                if (userAnswers[i] !== undefined) {
                    colorStyle = 'bg-green-700 text-green-200'; // Answered
                }
                if (i === currentQuestionIndex) {
                    colorStyle = 'bg-blue-700 text-white ring-2 ring-blue-300'; // Current
                }

                item.className = `${baseStyle} ${colorStyle}`;
                item.addEventListener('click', () => renderQuestion(i));
                questionPalette.appendChild(item);
            }
        }

        function finishTest() {
            window.location.href = "{{ url_for('results') }}";
        }

        // --- INITIALIZATION ---
        nextBtn.addEventListener('click', () => renderQuestion(currentQuestionIndex + 1));
        finishBtn.addEventListener('click', finishTest);
        renderQuestion(0);
    });
    </script>
</body>
</html>